Description: Compute Stack Template

Parameters:
    OperatorEMail:
      Description: Set email to Get Notifications
      Type: String
      Default: syed.shadab@eurustechnologies.com
    InstanceTypeParameter: 
      Description: Select instance type
      Type: String
      Default: t2.micro
    KeyName:
      Description: Existing EC2 KeyPair to enable SSH access to the instance
      Type: AWS::EC2::KeyPair::KeyName
      Default: rsa-pub
    ImageAMI:
      Description: Enter AMI ID
      Type: String
      Default: ami-098e42ae54c764c35
    DBMaxSizeASG:
      Description: "Enter the Max Size for the DBASG"
      Type: String
      Default: 3
    DBMinSizeASG:
      Description: "Enter the Min Size for the DBASG"
      Type: String
      Default: 1
    DBDesiredCapacityASG:
      Description: "Enter the desired capacity for the DBASG"
      Type: String
      Default: 1

    WEBMaxSizeASG:
      Description: "Enter the Max Size for the WEBASG"
      Type: String
      Default: 3
    WEBMinSizeASG:
      Description: "Enter the Min Size for the WEBASG"
      Type: String
      Default: 1
    WEBDesiredCapacityASG:
      Description: "Enter the desired capacity for the WEBASG"
      Type: String
      Default: 1
    DBTargetGroup:
      Description: "Ref DBTargetGroup"
      Type: String

    WEBTargetGroup:
      Description: "Ref WEBTargetGroup"
      Type: String

    MySqlDBstreamSG:
      Description: "Ref MySqlDBstreamSG"
      Type: String

    WebserverAppSG:
      Description: "Ref WebserverAppSG"
      Type: String

    PublicSubnet1:
      Description: "Ref PublicSubnet1"
      Type: String

    PrivateSubnet1:
      Description: "Ref PrivateSubnet1"
      Type: String

    PrivateSubnet2:
      Description: "Ref PrivateSubnet2"
      Type: String

    DBelb:
      Description: "Ref PrivateSubnet2"
      Type: String 

# Metadata:
#   AWS::CloudFormation::Interface:
#     ParameterGroups:
#       - Label:
#           default: Compute Stack
#           Parameters:
#             - OperatorEMail	
#             - InstanceTypeParameter
#             - KeyName
#             - ImageAMI
#             - DBMaxSizeASG
#             - DBMinSizeASG
#             - DBDesiredCapacityASG
#             - WEBMaxSizeASG
#             - WEBMinSizeASG
#             - WEBDesiredCapacityASG
#     ParametersLabels:
#       OperatorEMail	
#       InstanceTypeParameter
#       KeyName
#       ImageAMI
#       DBMaxSizeASG
#       DBMinSizeASG
#       DBDesiredCapacityASG
#       WEBMaxSizeASG
#       WEBMinSizeASG
#       WEBDesiredCapacityASG
Resources:
  DBConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      LaunchConfigurationName: !Sub '${AWS::StackName}DBConfig'
      IamInstanceProfile: Ec2-role-for-autoscaling
      ImageId: !Ref "ImageAMI"
      SecurityGroups: 
        - Ref: MySqlDBstreamSG
      InstanceType: !Ref "InstanceTypeParameter"
      KeyName: !Ref "KeyName"
      AssociatePublicIpAddress: "false"
      UserData: 
        Fn::Base64: |
          #!/bin/bash
          sudo yum update -y
          sudo amazon-linux-extras install -y lamp-mariadb10.2-php7.2 
          db_username=$(aws ssm get-parameter --name db_username --query 'Parameter.Value' --region us-east-1 --output text)
          db_user_password=$(aws ssm get-parameter --name db_user_password --query 'Parameter.Value' --region us-east-1 --output text)
          db_name=$(aws ssm get-parameter --name db_name --query 'Parameter.Value' --region us-east-1 --output text)
          sudo yum update -y
          sudo amazon-linux-extras install -y lamp-mariadb10.2-php7.2 
          sudo yum install -y httpd
          sudo yum install mysql-server -y
          sudo systemctl enable mariadb
          sudo systemctl start mariadb
          sudo yum install git -y 
          git clone -b master  https://github.com/KhalidLam/PHP-Blog.git /tmp/shadab
          mysql -h localhost -u root -e "create database blog"
          cat /tmp/shadab/blog.sql | mysql -h localhost -u root blog
          mysql -h localhost -u root -e "CREATE USER '$db_username'@'%' IDENTIFIED BY '$db_user_password'"
          mysql -h localhost -u root -e "GRANT ALL PRIVILEGES ON $db_name.* TO '$db_username'@'%' WITH GRANT OPTION"
          sudo yum -y install expect
          MYSQL_PASS=$db_user_password
          myPid=$!
          echo "--> Wait 7s to boot up MySQL on pid ${myPid}"
          sleep 7
          echo "--> Set root password"
          expect -f - <<-EOF
            set timeout 10
            spawn mysql_secure_installation
            expect "Enter current password for root (enter for none):"
            send -- "\r"
            expect "Set root password?"
            send -- "y\r"
            expect "New password:"
            send -- "${MYSQL_PASS}\r"
            expect "Re-enter new password:"
            send -- "${MYSQL_PASS}\r"
            expect "Remove anonymous users?"
            send -- "y\r"
            expect "Disallow root login remotely?"
            send -- "n\r"
            expect "Remove test database and access to it?"
            send -- "y\r"
            expect "Reload privilege tables now?"
            send -- "y\r"
            expect eof
          EOF
          echo "--> Kill MySQL on pid ${myPid}"
          kill -9 ${myPid}          

  WEBConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      LaunchConfigurationName: !Sub '${AWS::StackName}WEBConfig'
      IamInstanceProfile: Ec2-role-for-autoscaling
      ImageId: !Ref "ImageAMI"
      SecurityGroups: 
        - Ref: WebserverAppSG       
      InstanceType: !Ref "InstanceTypeParameter"
      KeyName: !Ref "KeyName"
      AssociatePublicIpAddress: "false"
      UserData: !Base64 
        'Fn::Sub': 
          - |-    
            #!/bin/bash
            sudo yum update -y
            access_token=$(aws ssm get-parameter --name "git_access_token_ss1680" --query 'Parameter.Value' --region us-east-1 --with-decryption --output text 2>&1 | sed 's/.*----BEGIN/----BEGIN/')
            db_username=$(aws ssm get-parameter --name db_username --query 'Parameter.Value' --region us-east-1 --output text)
            db_user_password=$(aws ssm get-parameter --name db_user_password --query 'Parameter.Value' --region us-east-1 --output text)
            db_name=$(aws ssm get-parameter --name db_name --query 'Parameter.Value' --region us-east-1 --output text)
            sudo amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2 -y
            sudo yum install httpd -y 
            sudo systemctl enable httpd
            sudo systemctl start httpd php-fpm
            sudo usermod -a -G apache ec2-user
            sudo yum install git -y
            git clone -b CloudFormation https://${access_token}@github.com/shadabshah1680/Eurus_Work.git /tmp/tmp_repo
            sudo cp -rf /tmp/tmp_repo/aws/cloudformation/blog/* /var/www/html
            sudo chown -R ec2-user:apache /var/www
            sudo chmod 2775 /var/www && find /var/www -type d -exec sudo chmod 2775 {} \;
            find /var/www -type f -exec sudo chmod 0664 {} \;
            sudo yum install jq -y
            # aws configure set region us-east-2
            # a=`aws elbv2 describe-load-balancers --query 'LoadBalancers[*].DNSName' | jq -r 'to_entries[ ] | .value' | grep DBelb`
            sed -i "s|db_name|$db_name|g" /var/www/html/assest/db.php
            sed -i "s|user|$db_username|g" /var/www/html/assest/db.php
            sed -i "s|pass|$db_user_password|g" /var/www/html/assest/db.php
            sed -i "s|localhost|${elbdnsname}|g" /var/www/html/assest/db.php
          - {elbdnsname: !Ref DBelb}

  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref OperatorEMail
          Protocol: email
  
######################################################
# 
#    DataBase   AutoScaling   Groups          
#
######################################################

  DBAsg:          
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties: 
      LaunchConfigurationName: !Sub '${AWS::StackName}DBConfig'
      AutoScalingGroupName: !Sub '${AWS::StackName}DBAsg'
      MinSize: !Ref DBMinSizeASG
      MaxSize: !Ref DBMaxSizeASG
      DesiredCapacity: !Ref DBDesiredCapacityASG
      HealthCheckGracePeriod: 600
      HealthCheckType: ELB
      TargetGroupARNs:
        - Ref: DBTargetGroup
      VPCZoneIdentifier:
        - Ref: PrivateSubnet1
        - Ref: PrivateSubnet2
      NotificationConfiguration:
        TopicARN: !Ref NotificationTopic
        NotificationTypes:
          - 'autoscaling:EC2_INSTANCE_LAUNCH'
          - 'autoscaling:EC2_INSTANCE_LAUNCH_ERROR'
          - 'autoscaling:EC2_INSTANCE_TERMINATE'
          - 'autoscaling:EC2_INSTANCE_TERMINATE_ERROR'        
      Tags:
        - Key: Name
          PropagateAtLaunch: true




          Value: !Sub "${AWS::StackName}AutoScaledDB"
     
    DependsOn: DBConfig

######################################################
# 
#    Web   AutoScaling   Group          
#
######################################################

  WEBAsg:          
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties: 
      LaunchConfigurationName: !Sub '${AWS::StackName}WEBConfig'
      AutoScalingGroupName: !Sub '${AWS::StackName}WEBAsg'
      MinSize: !Ref WEBMinSizeASG
      MaxSize: !Ref WEBMaxSizeASG
      DesiredCapacity: !Ref WEBDesiredCapacityASG
      HealthCheckGracePeriod: 600
      HealthCheckType: ELB
      TargetGroupARNs: 
        - Ref: WEBTargetGroup
      VPCZoneIdentifier:
        - Ref: PrivateSubnet1
        - Ref: PrivateSubnet2
      NotificationConfiguration:
        TopicARN: !Ref NotificationTopic
        NotificationTypes:
          - 'autoscaling:EC2_INSTANCE_LAUNCH'
          - 'autoscaling:EC2_INSTANCE_LAUNCH_ERROR'
          - 'autoscaling:EC2_INSTANCE_TERMINATE'
          - 'autoscaling:EC2_INSTANCE_TERMINATE_ERROR'
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value: !Sub "${AWS::StackName}AutoScaledWEB"     
    DependsOn: WEBConfig
  
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref BastionHost    

  BastionHost:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: !Ref ImageAMI
      InstanceType: t3a.nano
      KeyName: !Ref KeyName
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - Ref: WebserverAppSG
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 8
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}Bastion-Host'    
      UserData:
        Fn::Base64: !Sub |
          echo "Shadab Deployed" > /home/$User/user.txt

Outputs:

  WEBAsg:
    Description: "Ref WEBAsg"
    Value: !Ref WEBAsg
